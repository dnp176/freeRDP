name: Ubuntu RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install XRDP and Desktop Environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xfce4-session \
            xorg \
            dbus-x11 \
            x11-xserver-utils \
            xrdp \
            firefox \
            policykit-1-gnome

      - name: Configure XRDP and XFCE Session
        run: |
          # Stop and disable problematic services
          sudo systemctl stop lightdm 2>/dev/null || true
          sudo systemctl disable lightdm 2>/dev/null || true
          
          # Configure XRDP properly
          sudo sed -i 's/port=3389/port=tcp:\/\/:3389/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          
          # Fix XFCE session configuration
          sudo mkdir -p /etc/xdg/xfce4/xfconf/xfce-perchannel-xml
          sudo tee /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml > /dev/null << 'ENDOFFILE'
          <?xml version="1.0" encoding="UTF-8"?>
          
          <channel name="xfce4-session" version="1.0">
            <property name="general" type="empty">
              <property name="LockCommand" type="string" value=""/>
              <property name="SaveOnExit" type="bool" value="false"/>
            </property>
            <property name="sessions" type="empty">
              <property name="Failsafe" type="empty">
                <property name="IsFailsafe" type="bool" value="true"/>
                <property name="Count" type="int" value="5"/>
                <property name="Client0_Command" type="array">
                  <value type="string" value="xfce4-panel"/>
                </property>
                <property name="Client0_PerScreen" type="bool" value="false"/>
                <property name="Client1_Command" type="array">
                  <value type="string" value="Thunar"/>
                  <value type="string" value="--daemon"/>
                </property>
                <property name="Client1_PerScreen" type="bool" value="false"/>
                <property name="Client2_Command" type="array">
                  <value type="string" value="xfdesktop"/>
                </property>
                <property name="Client2_PerScreen" type="bool" value="false"/>
                <property name="Client3_Command" type="array">
                  <value type="string" value="xfce4-power-manager"/>
                </property>
                <property name="Client3_PerScreen" type="bool" value="false"/>
              </property>
            </property>
          </channel>
          ENDOFFILE

          # Create proper startwm.sh for XRDP
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'ENDOFFILE'
          #!/bin/sh
          # /etc/xrdp/startwm.sh
          
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi

          # Set XDG environment variables
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_CONFIG_DIRS=/etc/xdg/xdg-xfce:/etc/xdg
          export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share:/usr/local/share

          # Start DBus
          if [ -d /run/dbus ]; then
            sudo dbus-daemon --config-file=/usr/share/dbus-1/system.conf
          fi

          # Start XFCE
          exec startxfce4
          ENDOFFILE
                    sudo chmod +x /etc/xrdp/startwm.sh
          
                    # Create user session file
                    echo '#!/bin/sh
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_CONFIG_DIRS=/etc/xdg/xdg-xfce:/etc/xdg
          export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share:/usr/local/share
          
          exec startxfce4' | sudo tee /usr/bin/startxfce4-xrdp
          sudo chmod +x /usr/bin/startxfce4-xrdp

      - name: Create RDP User with Secure Password
        run: |
          # Generate secure password
          PASSWORD=$(openssl rand -base64 12 | tr -d '=' | tr '+/' '##')
          USERNAME="ubuntu"
          
          # Create user if not exists
          if ! id "$USERNAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash -G sudo $USERNAME
          fi
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          
          # Setup user XFCE configuration
          sudo mkdir -p /home/$USERNAME/.config/xfce4/xfconf/xfce-perchannel-xml
          sudo cp /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml /home/$USERNAME/.config/xfce4/xfconf/xfce-perchannel-xml/
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME

          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Start RDP Services
        run: |
          # Configure firewall
          sudo ufw allow 3389/tcp 2>/dev/null || true
          
          # Ensure DBus is running properly
          sudo mkdir -p /run/dbus
          sudo dbus-daemon --system --fork
          sleep 2
          
          # Start XRDP
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sleep 5
          
          # Check status
          echo "XRDP Status:"
          sudo systemctl status xrdp --no-pager | head -5 || true

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-${{ github.run_id }} --accept-routes

      - name: Get Tailscale IP
        run: |
          sleep 15
          TS_IP=$(sudo tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Retrying Tailscale IP..."
            sleep 10
            TS_IP=$(sudo tailscale ip -4)
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Final Setup Verification
        run: |
          echo "=== FINAL SETUP CHECK ==="
          echo "1. XRDP Service:"
          sudo systemctl is-active xrdp && echo "ACTIVE" || echo "INACTIVE"
          echo ""
          echo "2. Listening on RDP port:"
          sudo netstat -tlnp | grep :3389 || echo "Not listening on 3389"
          echo ""
          echo "3. Tailscale Status:"
          sudo tailscale status
          echo ""
          echo "4. User created:"
          id $RDP_USER && echo "User OK" || echo "User missing"
          echo "========================="

      - name: Maintain RDP Connection
        run: |
          echo ""
          echo "üéØ UBUNTU RDP READY üéØ"
          echo "üìç Address: $TAILSCALE_IP"
          echo "üë§ Username: $RDP_USER"
          echo "üîë Password: $RDP_PASSWORD"
          echo "üïê Port: 3389"
          echo "========================"
          echo ""
          echo "Use Remote Desktop Client to connect"
          echo "Session will auto-end after 6 hours"
          
          # Keep alive with service monitoring
          counter=0
          while [ $counter -lt 360 ]; do
            if ! sudo systemctl is-active xrdp > /dev/null; then
              echo "‚ö†Ô∏è  XRDP stopped, restarting..."
              sudo systemctl start xrdp
            fi
            echo "[$(date +'%H:%M:%S')] RDP Active - $(expr 360 - $counter) min left"
            sleep 60
            counter=$((counter + 1))
          done
          echo "‚è∞ RDP session ending"
