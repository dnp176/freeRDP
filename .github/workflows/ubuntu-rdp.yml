name: Ubuntu RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install XRDP and Desktop Environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xorg \
            dbus-x11 \
            x11-xserver-utils \
            xrdp \
            firefox

      - name: Configure XRDP Settings
        run: |
          # Stop and disable problematic services
          sudo systemctl stop lightdm 2>/dev/null || true
          sudo systemctl disable lightdm 2>/dev/null || true
          
          # Configure XRDP properly
          sudo sed -i 's/port=3389/port=tcp:\/\/:3389/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/ssl_protocols=TLSv1.2, TLSv1.3/ssl_protocols=TLSv1.2/g' /etc/xrdp/xrdp.ini
          
          # Fix session configuration
          echo 'xfce4-session' > ~/.xsession
          sudo mkdir -p /etc/skel
          sudo cp ~/.xsession /etc/skel/
          
          # Create proper startwm.sh
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'ENDOFFILE'
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi

          export XDG_SESSION_TYPE=x11
          export GDK_BACKEND=x11
          
          # Start XFCE
          startxfce4
          ENDOFFILE
          sudo chmod +x /etc/xrdp/startwm.sh

      - name: Create RDP User with Secure Password
        run: |
          # Generate secure password
          PASSWORD=$(openssl rand -base64 12 | tr -d '=' | tr '+/' '##')
          USERNAME="ubuntu"
          
          # Create user if not exists
          if ! id "$USERNAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash -G sudo $USERNAME
          fi
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          
          # Setup user environment
          sudo mkdir -p /home/$USERNAME
          sudo cp ~/.xsession /home/$USERNAME/ 2>/dev/null || true
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME
          
          echo "RDP_CREDS=User:$USERNAME|Password:$PASSWORD" >> $GITHUB_ENV

      - name: Start RDP Services
        run: |
          # Configure firewall
          sudo ufw allow 3389/tcp 2>/dev/null || true
          
          # Ensure DBus is running
          sudo systemctl enable dbus
          sudo systemctl start dbus
          sleep 2
          
          # Start XRDP
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sleep 5
          
          # Check status
          sudo systemctl status xrdp --no-pager || true

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-${{ github.run_id }} --accept-routes

      - name: Get Tailscale IP
        run: |
          sleep 15
          TS_IP=$(sudo tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Retrying Tailscale IP..."
            sleep 10
            TS_IP=$(sudo tailscale ip -4)
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Verify RDP Setup
        run: |
          echo "=== RDP SETUP VERIFICATION ==="
          echo "XRDP Status:"
          sudo systemctl status xrdp --no-pager | head -10 || true
          echo ""
          echo "Listening ports:"
          sudo netstat -tlnp | grep :3389 || true
          echo ""
          echo "Tailscale status:"
          sudo tailscale status || true
          echo "=============================="

      - name: Maintain RDP Connection
        run: |
          echo ""
          echo "=== UBUNTU RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: ubuntu"
          echo "Password: $(echo $RDP_CREDS | cut -d'|' -f2 | cut -d':' -f2)"
          echo "========================="
          echo ""
          echo "RDP is ready! Connect using Remote Desktop Client"
          echo "Workflow will remain active for 6 hours max"
          
          # Keep alive loop
          counter=0
          while [ $counter -lt 360 ]; do
            echo "[$(date +'%H:%M:%S')] RDP Active - $(expr 360 - $counter) minutes remaining"
            # Verify services are still running
            sudo systemctl is-active xrdp > /dev/null || echo "XRDP service issue detected"
            sleep 60
            counter=$((counter + 1))
          done
          echo "RDP session ending due to timeout"
