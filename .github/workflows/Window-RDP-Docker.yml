name: Window-RDP-Docker

on:
  workflow_dispatch:

jobs:
  setup-rdp-docker:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP & Configure Firewall
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          # Configure Firewall for RDP
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create RDP User (fixed password)
        run: |
          # Use a fixed password as requested
          $plain = 'Test@123456789$'
          $secure = ConvertTo-SecureString $plain -AsPlainText -Force

          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $secure -AccountNeverExpires -PasswordNeverExpires
          } else {
              # If user exists, update the password
              $user = Get-LocalUser -Name "RDP"
              $user | Set-LocalUser -Password $secure
          }

          # Ensure membership
          Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue

          # Export password to environment for workflow logs (be careful â€” this will appear in logs)
          echo "RDP_PASSWORD=$plain" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $file = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $file
          Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait
          Remove-Item $file -Force

      - name: Connect to Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-winrdp-docker-$env:GITHUB_RUN_ID

          $tsIP = $null
          for ($i=0; $i -lt 10; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($tsIP) { break }
              Start-Sleep -Seconds 5
          }

          if (-not $tsIP) {
              Write-Error "No Tailscale IP detected!"
              exit 1
          }

          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Enable Docker prerequisites (WSL2, VirtualMachinePlatform, Hyper-V, Containers)
        run: |
          Write-Host "Attempting to enable Windows features required for Docker..."
          # Enable WSL and Virtual Machine Platform (WSL2)
          try {
              Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -NoRestart -ErrorAction Stop
              Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -NoRestart -ErrorAction Stop
          } catch {
              Write-Warning "Failed to enable WSL/VirtualMachinePlatform (may require elevated permissions or unsupported runner). $_"
          }

          # Enable Hyper-V (all) and Containers feature
          try {
              Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All -NoRestart -ErrorAction Stop
          } catch {
              Write-Warning "Failed to enable Hyper-V (may be unsupported on this runner). $_"
          }

          try {
              Enable-WindowsOptionalFeature -Online -FeatureName Containers -NoRestart -ErrorAction Stop
          } catch {
              Write-Warning "Failed to enable Containers feature. $_"
          }

          # WSL update and set default to version 2 (if wsl.exe present)
          if (Get-Command wsl -ErrorAction SilentlyContinue) {
              try {
                  wsl --update
                  wsl --set-default-version 2
              } catch {
                  Write-Warning "wsl commands failed or not supported on this runner. $_"
              }
          } else {
              Write-Warning "wsl.exe not found on this runner."
          }

          Write-Host "Docker prerequisites enabling step finished. Check logs for any warnings."

      - name: Display Connection Info
        run: |
          Write-Host "`n=== RDP + DOCKER PREREQS READY (Docker NOT installed) ==="
          Write-Host "Tailscale IP : $env:TAILSCALE_IP"
          Write-Host "Username     : RDP"
          Write-Host "Password     : $env:RDP_PASSWORD"
          Write-Host "NOTE: Docker Desktop installation was intentionally skipped per request."
          Write-Host "==========================`n"

      - name: Keep Session Alive
        run: |
          while ($true) {
              Write-Host "[$(Get-Date)] Windows RDP + Docker-prereqs Active..."
              Start-Sleep -Seconds 300
          }
