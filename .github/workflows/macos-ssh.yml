name: macOS SSH Access

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Create SSH User (non-blocking)
        run: |
          # Generate secure random password
          CHARSET="A-Za-z0-9@#%^&*_-"
          PASSWORD=$(LC_ALL=C tr -dc "$CHARSET" < /dev/urandom | head -c 16)
          echo "Generated password: $PASSWORD"

          USERNAME="remote"
          HOMEDIR="/Users/$USERNAME"

          # Create user account using dscl
          sudo dscl . -create /Users/$USERNAME
          sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
          sudo dscl . -create /Users/$USERNAME RealName "Remote User"
          sudo dscl . -create /Users/$USERNAME UniqueID "510"
          sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
          sudo dscl . -create /Users/$USERNAME NFSHomeDirectory "$HOMEDIR"
          sudo dscl . -passwd /Users/$USERNAME "$PASSWORD"

          # Create home directory manually
          sudo mkdir -p "$HOMEDIR"
          sudo chown -R "$USERNAME":staff "$HOMEDIR"

          # Enable SSH access
          sudo systemsetup -setremotelogin on
          sudo dseditgroup -o edit -a "$USERNAME" -t user com.apple.access_ssh

          # Save credentials to env
          echo "SSH_USER=$USERNAME" >> $GITHUB_ENV
          echo "SSH_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Connect Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-macos-${GITHUB_RUN_ID}

          for i in {1..10}; do
            IP=$(tailscale ip -4 | head -n1)
            if [ -n "$IP" ]; then
              echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV
              break
            fi
            sleep 5
          done

      - name: Verify SSH Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv "$TAILSCALE_IP" 22 || (echo "SSH port not reachable" && exit 1)
          echo "SSH connectivity verified."

      - name: Display SSH Credentials
        run: |
          echo ""
          echo "=== SSH ACCESS INFO ==="
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username: $SSH_USER"
          echo "Password: $SSH_PASS"
          echo "========================"
          echo ""

      - name: Keep macOS Active
        run: |
          echo "macOS SSH session active. Use Ctrl+C in Actions UI to stop."
          while true; do
            echo "[$(date)] SSH Active"
            sleep 300
          done
